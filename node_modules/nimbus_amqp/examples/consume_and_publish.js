
var amqp = require('../index.js');

var global_amqp = null;

global_amqp = amqp.factory({
	host : ['rabbitmq-01.nimbus', 'rabbitmq-02.nimbus', 'rabbitmq-03.nimbus'],
	queues : { mongo_write_errors: {  prefetch_count : 20, on_message: got_message}},
	exchanges: { hq_tasks : {  type: 'topic', durable:'true'}}},

	function(err, a){	
			console.log("Amqp is ready", a.tasks);
			global_amqp = a;
	}
);

function got_message(msg, headers, deliveryInfo, message){
//	console.log(msg);
	global_amqp.hq_tasks.publish('mongo_write.recovery', msg, {},function(err){
		console.warn("Got error publishing", err);
	});
    message.acknowledge();
}


